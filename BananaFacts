const Alexa = require('alexa-sdk');


module.exports = async function (context, req) {
    var alexa = require('alexa-skill-sdk-for-azure-function');
        alexa.setup({
            azureCtx: context,
            azureReq: req,
            handlers: null,
            trackInvokedIntents: true,
            enforceVerifier: false
        });
        
        alexa.execute(avsCallback(context, req));
}
var avsCallback = function (azureCtx, req) {
        return function (err, obj) {
            azureCtx.log('obj: '+JSON.stringify(obj));

            if (err) {
                azureCtx.res = {
                    status: 400,
                    body: err
                };
            } else {
                azureCtx.res = {
                    body: obj
                };
            }
            azureCtx.done();
        };
    };
    
    const handlers = {
        'LaunchRequest': function () {
            console.log("Launch Request");
            this.emit('SayHello');
        },
        'HelloWorldIntent': function () {
            console.log("HelloWorldIntent Request");
            this.emit('SayHello');
        },
        'SayHello': function () {
            this.response.speak('Hello World!');
            
            // Prints Response to log
            console.log("==RESPONSE== " + JSON.stringify(this.handler.response));
            this.emit(':responseReady');
        },
        'AMAZON.HelpIntent': function () {
            const speechOutput = 'This is the Hello World Sample Skill. ';
            const reprompt = 'Say hello, to hear me speak.';
    
            this.response.speak(speechOutput).listen(reprompt);
            this.emit(':responseReady');
        },
        'AMAZON.CancelIntent': function () {
            this.response.speak('Goodbye!');
            this.emit(':responseReady');
        },
        'AMAZON.StopIntent': function () {
            this.response.speak('See you later!');
            this.emit(':responseReady');
        }
    };
  